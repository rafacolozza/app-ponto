import pandas as pd
import streamlit as st
from io import BytesIO

from ponto_parser import processar_espelho_ponto_bytes

# ----------------------------
# CONFIGURA√á√ÉO DA P√ÅGINA
# ----------------------------
st.set_page_config(
    page_title="Resumo de Ponto - Alva Serv",
    page_icon="üïí",
    layout="wide",
)

# ----------------------------
# CONTROLES DE ESTADO
# ----------------------------
if "uploader_key" not in st.session_state:
    st.session_state["uploader_key"] = 0


# ----------------------------
# ESTILOS (CSS)
# ----------------------------
st.markdown(
    """
    <style>
    .stApp {
        background-color: #f5f7fb;
    }

    .alva-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 0;
        color: #1f2933;
    }

    .alva-subtitle {
        font-size: 14px;
        color: #6b7280;
        margin-top: 4px;
    }

    .alva-card {
        background: #ffffff;
        padding: 20px 24px;
        border-radius: 14px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
        margin-bottom: 20px;
    }

    .stDownloadButton button {
        border-radius: 999px;
        padding: 0.6rem 1.8rem;
        font-weight: 600;
    }

    .metric-label {
        font-size: 13px;
        color: #6b7280;
    }
    </style>
    """,
    unsafe_allow_html=True,
)

# ----------------------------
# SIDEBAR (NAVEGA√á√ÉO)
# ----------------------------
with st.sidebar:
    st.image("logo_alvaserv.png", use_container_width=True)
    st.markdown("### Navega√ß√£o")
    pagina = st.radio(
        "",
        ["Resumo de Ponto", "Ajuda / Como usar"],
        index=0,
    )
    st.markdown("---")
    st.markdown("**Alva Serv ‚Äì Verificador de Ponto**")
    st.caption("Vers√£o 1.0")


# ----------------------------
# HEADER COM LOGO + T√çTULO
# ----------------------------
with st.container():
    col_logo, col_title = st.columns([1, 3], gap="medium")

    with col_logo:
        st.image("logo_alvaserv.png", use_container_width=True)

    with col_title:
        st.markdown(
            "<div class='alva-title'>Resumo de Ponto - Alva Serv</div>",
            unsafe_allow_html=True,
        )
        st.markdown(
            "<div class='alva-subtitle'>Carregue os espelhos de ponto em PDF (um por escola). "
            "O sistema consolida e gera uma planilha detalhada para confer√™ncia e arquivamento.</div>",
            unsafe_allow_html=True,
        )

st.markdown("")  # espa√ßamento


# ============================================================
# P√ÅGINA 1 ‚Äì RESUMO DE PONTO
# ============================================================
if pagina == "Resumo de Ponto":
    # ----------------------------
    # BLOCO DE UPLOAD
    # ----------------------------
    with st.container():
        st.markdown("<div class='alva-card'>", unsafe_allow_html=True)

        st.markdown("### üìÇ Upload de espelhos de ponto")
        st.markdown(
            "- Voc√™ pode selecionar **um ou v√°rios PDFs** de uma vez.\n"
            "- Os PDFs precisam estar no modelo de espelho de ponto padr√£o.\n"
            "- Ao final, ser√° gerado um **Excel consolidado**."
        )

        arquivos_pdf = st.file_uploader(
            "Selecione os arquivos de ponto em PDF",
            type=["pdf"],
            accept_multiple_files=True,
            key=f"upload_pdf_{st.session_state['uploader_key']}",
        )

        st.markdown("</div>", unsafe_allow_html=True)

    # ---------------------------------
    # PROCESSAMENTO
    # ---------------------------------
    if arquivos_pdf:
        st.markdown("")  # espa√ßamento

        with st.container():
            st.markdown("<div class='alva-card'>", unsafe_allow_html=True)
            st.markdown("### ‚öôÔ∏è Processamento")

            st.info(f"{len(arquivos_pdf)} arquivo(s) carregado(s).")

            dfs = []
            for arquivo_pdf in arquivos_pdf:
                with st.spinner(f"Processando: {arquivo_pdf.name}"):
                    pdf_bytes = arquivo_pdf.read()
                    df_resumo = processar_espelho_ponto_bytes(pdf_bytes)

                if df_resumo.empty:
                    st.warning(
                        f"N√£o foi poss√≠vel extrair dados de **{arquivo_pdf.name}**. "
                        "Confirme se o layout est√° no padr√£o."
                    )
                    continue

                df_resumo["Arquivo"] = arquivo_pdf.name
                dfs.append(df_resumo)

            if not dfs:
                st.error("Nenhum PDF p√¥de ser processado. Verifique os arquivos enviados.")
            else:
                df_master = pd.concat(dfs, ignore_index=True)

                # Remover coluna 'Pagina' se existir
                if "Pagina" in df_master.columns:
                    df_master = df_master.drop(columns=["Pagina"])

                # Criar coluna 'Mes_Referencia'
                df_master["Mes_Referencia"] = pd.to_datetime(
                    df_master["Periodo_Fim"], format="%d/%m/%Y"
                ).dt.to_period("M").astype(str)

                st.success("Processamento conclu√≠do com sucesso!")

                # ----------------------------
                # METRICS DE RESUMO
                # ----------------------------
                col_m1, col_m2, col_m3, col_m4 = st.columns(4)
                total_func = df_master["Nome"].nunique()
                total_escolas = df_master["Centro de Custo"].nunique()
                total_meses = df_master["Mes_Referencia"].nunique()
                total_linhas = len(df_master)

                col_m1.metric("Funcion√°rios", total_func)
                col_m2.metric("Escolas", total_escolas)
                col_m3.metric("Meses de refer√™ncia", total_meses)
                col_m4.metric("Registros na planilha", total_linhas)

                st.markdown("")

                # ----------------------------
                # TABELA DETALHADA (view mais amig√°vel)
                # ----------------------------
                st.markdown("### üìä Planilha detalhada")
                st.caption("Tabela consolidada por funcion√°rio, escola e per√≠odo.")

                # Renomear apenas para exibi√ß√£o (Excel continua com nomes t√©cnicos)
                df_display = df_master.rename(
                    columns={
                        "Centro de Custo": "Centro de Custo",
                        "Nome": "Nome",
                        "Periodo_Inicio": "Per√≠odo In√≠cio",
                        "Periodo_Fim": "Per√≠odo Fim",
                        "Dias_trabalhados": "Dias Trabalhados",
                        "Dias_abono": "Dias Abono",
                        "Dias_ferias": "Dias F√©rias",
                        "Dias_falta": "Dias Falta",
                        "Abono_Atestado": "Abono ‚Äì Atestado",
                        "Abono_Feriado": "Abono ‚Äì Feriado",
                        "Abono_Folga": "Abono ‚Äì Folga",
                        "Arquivo": "Arquivo Origem",
                        "Mes_Referencia": "M√™s de Refer√™ncia",
                    }
                )

                st.dataframe(df_display, use_container_width=True)

                # Criar Excel a partir do df_master original (n√£o renomeado)
                def gerar_excel_bytes(df):
                    output = BytesIO()
                    with pd.ExcelWriter(output, engine="openpyxl") as writer:
                        df.to_excel(writer, index=False, sheet_name="Detalhado")
                    return output.getvalue()

                excel_bytes = gerar_excel_bytes(df_master)

                st.markdown("---")
                st.markdown("### ‚¨áÔ∏è Exportar planilha")

                col_b1, col_b2 = st.columns([2, 1])

                with col_b1:
                    st.download_button(
                        label="Baixar Excel (planilha detalhada)",
                        data=excel_bytes,
                        file_name="resumo_ponto_alvaserv.xlsx",
                        mime=(
                            "application/vnd.openxmlformats-officedocument."
                            "spreadsheetml.sheet"
                        ),
                    )

                # ----------------------------
                # BOT√ÉO LIMPAR DADOS
                # ----------------------------
                with col_b2:
                    if st.button("üßπ Limpar dados e come√ßar novamente"):
                        # for√ßa recriar o componente de upload, limpando arquivos
                        st.session_state["uploader_key"] += 1
                        st.experimental_rerun()

            st.markdown("</div>", unsafe_allow_html=True)

    else:
        # nada enviado ainda ‚Üí card de instru√ß√µes r√°pido
        st.markdown("")
        with st.container():
            st.markdown("<div class='alva-card'>", unsafe_allow_html=True)
cd ~/app_ponto
source venv/bin/activate
nano app.py



